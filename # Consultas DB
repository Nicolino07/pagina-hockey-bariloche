# Definici√≥n de Endpoints del Sistema Hockey

Este documento describe los **endpoints necesarios** para el sistema, derivados directamente del esquema final de base de datos.

El objetivo es:

* organizar el trabajo backend/frontend
* identificar operaciones transaccionales
* separar CRUD de acciones de negocio
* dejar expl√≠citas las reglas ya garantizadas por la DB

---

## Convenciones generales

* Prefijo base: `/api/v1`
* Formato: REST
* JSON como formato de intercambio
* Fechas en ISO-8601
* Los endpoints de consulta **no modifican estado**
* Las vistas (`vw_*`) se usan solo para lectura

---

## 1. Seguridad y Autenticaci√≥n

| Caso de uso   | Endpoint      | M√©todo | Tablas                 | Transacci√≥n | Observaciones                 |
| ------------- | ------------- | ------ | ---------------------- | ----------- | ----------------------------- |
| Login         | /auth/login   | POST   | usuario, refresh_token | S√ç          | Genera access + refresh token |
| Refresh token | /auth/refresh | POST   | refresh_token          | S√ç          | Revoca token anterior         |
| Logout        | /auth/logout  | POST   | refresh_token          | S√ç          | Marca token como revocado     |

---

## 2. Clubes

| Caso de uso     | Endpoint     | M√©todo | Tablas | Transacci√≥n | Observaciones           |
| --------------- | ------------ | ------ | ------ | ----------- | ----------------------- |
| Crear club      | /clubes      | POST   | club   | NO          | Nombre √∫nico por ciudad |
| Actualizar club | /clubes/{id} | PUT    | club   | NO          | Auditor√≠a autom√°tica    |
| Eliminar club   | /clubes/{id} | DELETE | club   | NO          | Restricci√≥n por equipos |
| Listar clubes   | /clubes      | GET    | club   | NO          |                         |

---

## 3. Equipos

| Caso de uso       | Endpoint      | M√©todo | Tablas | Transacci√≥n | Observaciones              |
| ----------------- | ------------- | ------ | ------ | ----------- | -------------------------- |
| Crear equipo      | /equipos      | POST   | equipo | NO          | Asociado a club            |
| Actualizar equipo | /equipos/{id} | PUT    | equipo | NO          |                            |
| Eliminar equipo   | /equipos/{id} | DELETE | equipo | NO          | Restricci√≥n por torneos    |
| Listar equipos    | /equipos      | GET    | equipo | NO          | Filtros por club/categor√≠a |

---

## 4. Personas y Roles

| Caso de uso        | Endpoint                     | M√©todo | Tablas           | Transacci√≥n | Observaciones    |
| ------------------ | ---------------------------- | ------ | ---------------- | ----------- | ---------------- |
| Crear persona      | /personas                    | POST   | persona          | NO          | Documento √∫nico  |
| Actualizar persona | /personas/{id}               | PUT    | persona          | NO          |                  |
| Asignar rol        | /personas/{id}/roles         | POST   | persona_rol      | NO          | Validez temporal |
| Quitar rol         | /personas/{id}/roles/{idRol} | DELETE | persona_rol      | NO          | Fecha_hasta      |
| Ver roles          | /personas/{id}/roles         | GET    | vw_persona_roles | NO          | Vista            |

---

## 5. Planteles

| Caso de uso        | Endpoint                         | M√©todo | Tablas                 | Transacci√≥n | Observaciones         |
| ------------------ | -------------------------------- | ------ | ---------------------- | ----------- | --------------------- |
| Crear plantel      | /equipos/{id}/planteles          | POST   | plantel                | NO          | Uno activo por equipo |
| Agregar integrante | /planteles/{id}/integrantes      | POST   | plantel_integrante     | NO          | Valida rol            |
| Quitar integrante  | /planteles/{id}/integrantes/{id} | DELETE | plantel_integrante     | NO          | Fecha_baja            |
| Ver plantel        | /planteles/{id}                  | GET    | vw_plantel_integrantes | NO          | Vista                 |

---

## 6. Torneos

| Caso de uso       | Endpoint                    | M√©todo | Tablas             | Transacci√≥n | Observaciones    |
| ----------------- | --------------------------- | ------ | ------------------ | ----------- | ---------------- |
| Crear torneo      | /torneos                    | POST   | torneo             | NO          |                  |
| Actualizar torneo | /torneos/{id}               | PUT    | torneo             | NO          |                  |
| Inscribir equipo  | /torneos/{id}/inscripciones | POST   | inscripcion_torneo | NO          | √önico por torneo |
| Listar torneos    | /torneos                    | GET    | torneo             | NO          |                  |

---

## 7. Fixture

| Caso de uso     | Endpoint              | M√©todo | Tablas                         | Transacci√≥n | Observaciones |
| --------------- | --------------------- | ------ | ------------------------------ | ----------- | ------------- |
| Generar fixture | /torneos/{id}/fixture | POST   | fixture_fecha, fixture_partido | S√ç          | Algoritmo     |
| Ver fixture     | /torneos/{id}/fixture | GET    | fixture_*                      | NO          |               |

---

## 8. Partidos

| Caso de uso       | Endpoint                | M√©todo | Tablas                      | Transacci√≥n | Observaciones          |
| ----------------- | ----------------------- | ------ | --------------------------- | ----------- | ---------------------- |
| Crear partido     | /partidos               | POST   | partido, participan_partido | S√ç          | Desde fixture          |
| Registrar gol     | /partidos/{id}/goles    | POST   | gol                         | NO          |                        |
| Registrar tarjeta | /partidos/{id}/tarjetas | POST   | tarjeta, suspension         | S√ç          | Puede crear suspensi√≥n |
| Cerrar partido    | /partidos/{id}/cerrar   | POST   | partido                     | S√ç          | Recalcula posiciones   |

---

## 9. Disciplina

| Caso de uso              | Endpoint                   | M√©todo | Tablas / Vistas         | Transacci√≥n | Observaciones |
| ------------------------ | -------------------------- | ------ | ----------------------- | ----------- | ------------- |
| Ver suspensiones activas | /torneos/{id}/suspensiones | GET    | vw_suspensiones_activas | NO          |               |
| Cerrar suspensi√≥n        | /suspensiones/{id}/cerrar  | POST   | suspension              | NO          | Autom√°tico    |
| Historial disciplinario  | /personas/{id}/disciplina  | GET    | tarjeta, suspension     | NO          |               |
| Jugadores habilitados    | /torneos/{id}/habilitados  | GET    | fn_persona_suspendida   | NO          | Funci√≥n       |

---

## 10. Consultas y Reportes

| Caso de uso      | Endpoint                      | M√©todo | Vista               | Observaciones |
| ---------------- | ----------------------------- | ------ | ------------------- | ------------- |
| Tabla posiciones | /torneos/{id}/posiciones      | GET    | vw_tabla_posiciones |               |
| Fixture resumido | /torneos/{id}/fixture/resumen | GET    | vw_fixture_partidos |               |

---

## Notas finales

* Las validaciones cr√≠ticas est√°n en DB (triggers)
* El backend debe manejar errores SQL como errores de negocio
* Las transacciones deben manejarse a nivel servicio
* No recalcular posiciones manualmente

---

## Paso 1 ‚Äì Convenci√≥n definitiva de la API

Este apartado define los criterios generales que debe respetar toda la API del sistema. Su objetivo es garantizar coherencia, previsibilidad y una correcta separaci√≥n de responsabilidades entre backend y base de datos.

### 1. Estilo general

* La API sigue un enfoque **REST**.
* Los recursos se nombran en **plural**.
* Las URLs no contienen verbos, excepto en acciones de negocio expl√≠citas.
* El formato de intercambio es **JSON**.
* Prefijo fijo para todos los endpoints:

```
/api/v1
```

Ejemplos:

```
/api/v1/equipos
/api/v1/torneos/3/fixture
```

---

### 2. Uso de m√©todos HTTP

| M√©todo | Uso                                   |
| ------ | ------------------------------------- |
| GET    | Lectura de datos (no modifica estado) |
| POST   | Crear recursos o ejecutar acciones    |
| PUT    | Reemplazo completo de un recurso      |
| PATCH  | Modificaci√≥n parcial de un recurso    |
| DELETE | Eliminaci√≥n l√≥gica o f√≠sica           |

Reglas:

* No se utiliza `POST` para actualizar recursos existentes.
* No se utilizan endpoints `GET` para acciones que modifican estado.

---

### 3. Recursos vs acciones de negocio

#### Recursos (CRUD)

Se utilizan para operaciones simples sobre una sola entidad.

Ejemplo:

```
POST   /equipos
PUT    /equipos/{id}
DELETE /equipos/{id}
GET    /equipos
```

#### Acciones de negocio

Se utilizan cuando la operaci√≥n:

* involucra reglas de dominio,
* requiere una transacci√≥n,
* o no puede modelarse como un CRUD simple.

Ejemplos:

```
POST /partidos/{id}/cerrar
POST /torneos/{id}/fixture/generar
POST /suspensiones/{id}/cerrar
```

Este enfoque corresponde a un REST pragm√°tico orientado al dominio.

---

### 4. Transacciones

Un endpoint se considera transaccional cuando:

* opera sobre m√°s de una tabla,
* depende de reglas deportivas,
* o puede fallar parcialmente.

Ejemplos:

* crear un partido
* registrar una tarjeta
* cerrar un partido
* generar un fixture

Criterios:

* La transacci√≥n se maneja en la capa de servicio.
* La base de datos valida reglas e integridad.
* El controlador no contiene l√≥gica de negocio.

---

### 5. Responsabilidades: backend vs base de datos

**Backend**

* Validaci√≥n de formato y campos obligatorios
* Autorizaci√≥n y control de acceso
* Manejo de transacciones
* Traducci√≥n de errores SQL a c√≥digos HTTP

**Base de datos**

* Reglas deportivas y disciplinarias
* Integridad referencial
* C√°lculo de suspensiones y posiciones
* Auditor√≠a y consistencia

No se deben duplicar reglas de negocio entre backend y base de datos.

---

### 6. Convenci√≥n de errores HTTP

| Situaci√≥n                     | C√≥digo |
| ----------------------------- | ------ |
| Datos inv√°lidos               | 400    |
| Violaci√≥n de regla de negocio | 422    |
| Conflicto (unique, FK)        | 409    |
| Recurso inexistente           | 404    |
| Acceso no autorizado          | 403    |
| Error inesperado              | 500    |

Ejemplos:

* jugador suspendido ‚Üí 422
* equipo duplicado ‚Üí 409

---

### 7. Vistas y funciones de base de datos

* Las vistas (`vw_*`) se exponen √∫nicamente mediante endpoints `GET`.
* No se permite escritura directa sobre vistas.
* Las funciones (`fn_*`) encapsulan consultas o reglas de negocio complejas.
* El backend no expone SQL directo al cliente.

---

Este paso es obligatorio para el desarrollo de todos los endpoints del sistema y debe considerarse la referencia principal para futuras extensiones de la API.

---

## Paso 2 ‚Äì Roles del sistema

El sistema utiliza un conjunto reducido y estable de roles, definidos a nivel de aplicaci√≥n mediante un enum. La filosof√≠a general prioriza la flexibilidad operativa y la trazabilidad por sobre restricciones excesivamente granulares.

Los roles **definen el tipo de acciones permitidas**, no el alcance fino sobre instancias espec√≠ficas (partido, torneo, etc.).

---

### Roles definidos

#### 1. SUPERUSUARIO

**Descripci√≥n**
Rol t√©cnico con control l√≥gico total del sistema.

**Permisos**

* Crear, editar y borrar cualquier entidad
* Ejecutar todas las acciones de negocio
* Acceso completo a datos hist√≥ricos
* Uso administrativo y de soporte

---

#### 2. ADMIN

**Descripci√≥n**
Rol administrador funcional del sistema deportivo.

**Permisos**

* Crear, editar y borrar entidades clave del dominio deportivo
* Gestionar torneos, fixtures y partidos
* Ejecutar acciones de negocio cr√≠ticas:

  * generar fixture
  * cerrar partidos
  * cerrar suspensiones
* Acceso a consultas internas y reportes

---

#### 3. EDITOR

**Descripci√≥n**
Rol operativo para carga y edici√≥n de informaci√≥n.

**Permisos**

* Editar informaci√≥n existente en determinadas tablas
* Registrar incidencias deportivas:

  * tarjetas
  * resultados
  * datos operativos de partidos
* No puede borrar registros ni ejecutar acciones cr√≠ticas

El rol EDITOR **no se asigna por partido ni por torneo**; su capacidad es global dentro del sistema.

---

#### 4. LECTOR

**Descripci√≥n**
Rol de solo lectura para informaci√≥n no p√∫blica.

**Permisos**

* Acceso de lectura a:

  * planteles
  * historial disciplinario
  * suspensiones
  * datos internos del sistema
* No puede modificar datos

---

### P√∫blico (sin rol)

Usuarios no autenticados.

**Permisos**

* Lectura de informaci√≥n p√∫blica:

  * fixture
  * resultados
  * tabla de posiciones

---

### Criterios de autorizaci√≥n

* Los roles determinan **qu√© acciones** puede ejecutar un usuario.
* No se aplican restricciones por asignaci√≥n fina (partido, torneo, club).
* La coherencia de la operaci√≥n se valida por estado y reglas de dominio.
* Las acciones sensibles deben quedar registradas para auditor√≠a.

Este esquema busca maximizar la flexibilidad operativa del sistema manteniendo control y trazabilidad.

---

## Paso 2.1 ‚Äì Roles vs tipos de acci√≥n

Este apartado define, de forma transversal, qu√© tipos de acciones puede ejecutar cada rol. No se detallan endpoints espec√≠ficos; esta matriz se utiliza como referencia general para todo el dise√±o de la API.

El objetivo es mantener reglas simples, predecibles y f√°ciles de aplicar, evitando excepciones innecesarias.

---

### Tipos de acci√≥n definidos

Se identifican las siguientes categor√≠as de acciones:

1. **Crear (CREATE)**
   Alta de nuevas entidades o registros.

2. **Editar (UPDATE)**
   Modificaci√≥n de informaci√≥n existente.

3. **Borrar (DELETE)**
   Eliminaci√≥n l√≥gica o f√≠sica de registros.

4. **Acciones de negocio (ACTION)**
   Operaciones que modifican estado y ejecutan reglas de dominio (ej.: cerrar partido, generar fixture).

5. **Consulta interna (READ_INTERNO)**
   Lectura de informaci√≥n no p√∫blica.

6. **Consulta p√∫blica (READ_PUBLICO)**
   Lectura de informaci√≥n abierta sin autenticaci√≥n.

---

### Matriz de permisos por rol

| Rol          | CREATE | UPDATE | DELETE | ACTION | READ_INTERNO | READ_PUBLICO |
| ------------ | ------ | ------ | ------ | ------ | ------------ | ------------ |
| SUPERUSUARIO | ‚úîÔ∏è     | ‚úîÔ∏è     | ‚úîÔ∏è     | ‚úîÔ∏è     | ‚úîÔ∏è           | ‚úîÔ∏è           |
| ADMIN        | ‚úîÔ∏è     | ‚úîÔ∏è     | ‚úîÔ∏è*    | ‚úîÔ∏è     | ‚úîÔ∏è           | ‚úîÔ∏è           |
| EDITOR       | ‚ùå      | ‚úîÔ∏è     | ‚ùå      | ‚ùå      | ‚úîÔ∏è           | ‚úîÔ∏è           |
| LECTOR       | ‚ùå      | ‚ùå      | ‚ùå      | ‚ùå      | ‚úîÔ∏è           | ‚úîÔ∏è           |
| PUBLICO      | ‚ùå      | ‚ùå      | ‚ùå      | ‚ùå      | ‚ùå            | ‚úîÔ∏è           |

üìå *El permiso DELETE para ADMIN aplica solo a entidades habilitadas por el dominio y puede estar restringido en casos hist√≥ricos.

---

### Consideraciones generales

* Las acciones de negocio quedan restringidas a roles con responsabilidad administrativa.
* El rol EDITOR se enfoca exclusivamente en la edici√≥n operativa de datos.
* El rol LECTOR permite acceso a informaci√≥n sensible sin riesgo de modificaci√≥n.
* El p√∫blico accede √∫nicamente a informaci√≥n expresamente expuesta como p√∫blica.

Esta matriz es la referencia principal para autorizar cualquier endpoint del sistema.

---

## Paso 3 ‚Äì Dominios simples

En este paso se definen los endpoints correspondientes a los dominios b√°sicos del sistema. Son entidades centrales, con reglas simples y sin l√≥gica deportiva compleja. La mayor√≠a de las operaciones son CRUD tradicionales.

Los dominios incluidos en este paso son:

* Club
* Equipo
* Persona

---

### 3.1 Club

Entidad institucional base del sistema.

**Endpoints**

| M√©todo | Endpoint    | Acci√≥n        | Roles                          |
| ------ | ----------- | ------------- | ------------------------------ |
| POST   | /clubs      | Crear club    | SUPERUSUARIO, ADMIN            |
| PUT    | /clubs/{id} | Editar club   | SUPERUSUARIO, ADMIN            |
| DELETE | /clubs/{id} | Borrar club   | SUPERUSUARIO                   |
| GET    | /clubs      | Listar clubes | LECTOR, EDITOR, ADMIN, PUBLICO |
| GET    | /clubs/{id} | Ver club      | LECTOR, EDITOR, ADMIN, PUBLICO |

**Notas**

* El borrado puede ser l√≥gico seg√∫n reglas del dominio.
* Un club con equipos activos no deber√≠a borrarse sin validaci√≥n.

---

### 3.2 Equipo

Entidad deportiva dependiente de un club.

**Endpoints**

| M√©todo | Endpoint            | Acci√≥n                    | Roles                          |
| ------ | ------------------- | ------------------------- | ------------------------------ |
| POST   | /equipos            | Crear equipo              | SUPERUSUARIO, ADMIN            |
| PUT    | /equipos/{id}       | Editar equipo             | SUPERUSUARIO, ADMIN            |
| DELETE | /equipos/{id}       | Borrar equipo             | SUPERUSUARIO, ADMIN            |
| GET    | /equipos            | Listar equipos            | LECTOR, EDITOR, ADMIN, PUBLICO |
| GET    | /equipos/{id}       | Ver equipo                | LECTOR, EDITOR, ADMIN, PUBLICO |
| GET    | /clubs/{id}/equipos | Listar equipos de un club | LECTOR, EDITOR, ADMIN, PUBLICO |

**Notas**

* Un equipo puede existir sin estar inscripto en un torneo.
* El borrado debe validar que no tenga historial deportivo activo.

---

### 3.3 Persona

Entidad que representa a individuos (jugadores, t√©cnicos, √°rbitros, etc.).

**Endpoints**

| M√©todo | Endpoint       | Acci√≥n          | Roles                       |
| ------ | -------------- | --------------- | --------------------------- |
| POST   | /personas      | Crear persona   | SUPERUSUARIO, ADMIN         |
| PUT    | /personas/{id} | Editar persona  | SUPERUSUARIO, ADMIN, EDITOR |
| DELETE | /personas/{id} | Borrar persona  | SUPERUSUARIO                |
| GET    | /personas      | Listar personas | LECTOR, EDITOR, ADMIN       |
| GET    | /personas/{id} | Ver persona     | LECTOR, EDITOR, ADMIN       |

**Notas**

* Una persona puede existir sin pertenecer a un plantel.
* El borrado debe estar restringido si existe historial disciplinario o deportivo.

---

### Consideraciones generales del Paso 3

* Todos los endpoints de este paso son CRUD simples.
* No requieren transacciones complejas.
* No ejecutan reglas deportivas.
* Sirven como base para relaciones m√°s complejas en pasos posteriores.

Este paso establece los cimientos estructurales del sistema.

---

## Paso 4 ‚Äì Relaciones y dominios intermedios

Este paso introduce entidades que representan **relaciones** entre dominios b√°sicos y comienzan a requerir validaciones adicionales. Aunque muchas operaciones siguen siendo CRUD, aparecen las primeras reglas de consistencia.

Dominios incluidos:

* Plantel
* Integrantes de plantel
* Inscripci√≥n a torneos

---

### 4.1 Plantel

Representa el conjunto de personas asociadas a un equipo en un per√≠odo determinado.

**Endpoints**

| M√©todo | Endpoint                | Acci√≥n                        | Roles                 |
| ------ | ----------------------- | ----------------------------- | --------------------- |
| POST   | /planteles              | Crear plantel                 | SUPERUSUARIO, ADMIN   |
| PUT    | /planteles/{id}         | Editar plantel                | SUPERUSUARIO, ADMIN   |
| DELETE | /planteles/{id}         | Borrar plantel                | SUPERUSUARIO, ADMIN   |
| GET    | /planteles              | Listar planteles              | LECTOR, EDITOR, ADMIN |
| GET    | /planteles/{id}         | Ver plantel                   | LECTOR, EDITOR, ADMIN |
| GET    | /equipos/{id}/planteles | Listar planteles de un equipo | LECTOR, EDITOR, ADMIN |

**Notas**

* Un equipo puede tener m√∫ltiples planteles (por temporada o categor√≠a).
* Un plantel activo no deber√≠a borrarse sin validaci√≥n.

---

### 4.2 Integrantes de plantel (plantel_integrante)

Asociaci√≥n entre una persona y un plantel, con rol deportivo y vigencia.

**Endpoints**

| M√©todo | Endpoint                                    | Acci√≥n             | Roles                       |
| ------ | ------------------------------------------- | ------------------ | --------------------------- |
| POST   | /planteles/{id}/integrantes                 | Agregar integrante | SUPERUSUARIO, ADMIN, EDITOR |
| PUT    | /planteles/{id}/integrantes/{id_integrante} | Editar integrante  | SUPERUSUARIO, ADMIN, EDITOR |
| DELETE | /planteles/{id}/integrantes/{id_integrante} | Quitar integrante  | SUPERUSUARIO, ADMIN         |
| GET    | /planteles/{id}/integrantes                 | Listar integrantes | LECTOR, EDITOR, ADMIN       |

**Notas**

* No se permite duplicar personas activas en el mismo plantel.
* La vigencia define si un integrante est√° habilitado.

---

### 4.3 Inscripci√≥n a torneos (inscripcion_torneo)

Relaci√≥n entre equipos y torneos.

**Endpoints**

| M√©todo | Endpoint                                | Acci√≥n                    | Roles                          |
| ------ | --------------------------------------- | ------------------------- | ------------------------------ |
| POST   | /torneos/{id}/inscripciones             | Inscribir equipo          | SUPERUSUARIO, ADMIN            |
| DELETE | /torneos/{id}/inscripciones/{id_equipo} | Quitar inscripci√≥n        | SUPERUSUARIO, ADMIN            |
| GET    | /torneos/{id}/inscripciones             | Listar equipos inscriptos | LECTOR, EDITOR, ADMIN, PUBLICO |

**Notas**

* No se permite modificar inscripciones una vez generado el fixture.
* La DB debe validar unicidad y estado del torneo.

---

### Consideraciones generales del Paso 4

* Aparecen relaciones muchos-a-muchos.
* Algunas operaciones requieren validaciones de estado.
* Las reglas cr√≠ticas siguen siendo responsabilidad de la base de datos.
* Los endpoints mantienen coherencia con la convenci√≥n definida en el Paso 1.

Este paso conecta la estructura b√°sica con la l√≥gica deportiva.

---

## Paso 5 ‚Äì Torneos, Fixture y Partidos

### 5.1 Torneo

Un torneo agrupa equipos, define categor√≠a, g√©nero y per√≠odo de juego. Puede tener m√∫ltiples fases.

**Operaciones:** crear, editar, activar/desactivar, consultar.

**Roles:** SUPERUSUARIO, ADMIN

---

### 5.2 Inscripci√≥n de equipos

Relaciona equipos con torneos.

**Reglas:**

* Coincidencia de categor√≠a y g√©nero
* No duplicaci√≥n
* No eliminaci√≥n si hay fixture generado

**Operaciones:** inscribir, desinscribir, listar

**Roles:** SUPERUSUARIO, ADMIN

---

### 5.3 Fixture

El fixture es una acci√≥n de negocio.

**Acciones:**

* Generar fixture
* Consultar fixture
* Marcar partido como jugado

**Reglas:**

* No regenerable sin borrado
* No enfrentamientos duplicados por rueda

**Roles:** SUPERUSUARIO, ADMIN

---

### 5.4 Partido (real)

Entidad central del juego.

**Operaciones:** crear partido, editar resultado, asignar √°rbitros, cerrar partido

**Roles:** SUPERUSUARIO, ADMIN, EDITOR

---

## Paso 6 ‚Äì Eventos del partido y disciplina

### 6.1 Participantes

Define jugadores activos en el partido.

**Reglas:**

* Debe pertenecer al plantel
* No suspendido

**Operaciones:** registrar, quitar, listar

**Roles:** SUPERUSUARIO, ADMIN, EDITOR

---

### 6.2 Goles

Registro de goles.

**Operaciones:** registrar, anular, editar, listar

**Roles:** SUPERUSUARIO, ADMIN, EDITOR

---

### 6.3 Tarjetas

Registro disciplinario.

**Operaciones:** registrar, revisar, listar

**Roles:** SUPERUSUARIO, ADMIN, EDITOR

---

### 6.4 Suspensiones

Consecuencia disciplinaria.

**Operaciones:** crear, cerrar, listar activas

**Roles:** SUPERUSUARIO, ADMIN

---

### 6.5 Tabla de posiciones

Autom√°tica y no editable.

---

## Paso 7 ‚Äì Consultas, reportes y vistas

### 7.1 Consultas p√∫blicas

* Fixture
* Resultados
* Tabla de posiciones

---

### 7.2 Consultas privadas

* Planteles
* Eventos
* Suspensiones

---

### 7.3 Historial disciplinario

Consulta consolidada por persona.

**Roles:** SUPERUSUARIO, ADMIN

---

### 7.4 Reportes y estad√≠sticas

Consultas derivadas, solo lectura.

---

### 7.5 Auditor√≠a

Trazabilidad completa del sistema.

**Acceso:** SUPERUSUARIO

# Paso 8.4 ‚Äì Acciones de negocio

Estos endpoints representan operaciones propias del dominio hockey. No son CRUD simples y suelen involucrar m√∫ltiples tablas y validaciones.

## 8.4.1 Partido ‚Äì carga y cierre

### Registrar evento de partido

```
POST /api/partidos/{id_partido}/eventos
```

Eventos posibles:

* gol
* tarjeta amarilla
* tarjeta roja
* observaci√≥n

Roles:

* ADMIN
* EDITOR

Notas:

* Valida que el partido est√© abierto
* Impacta estad√≠sticas y disciplina

---

### Cerrar partido

```
POST /api/partidos/{id_partido}/cerrar
```

Descripci√≥n:
Marca el partido como finalizado y bloquea la carga de eventos.

Roles:

* ADMIN

Transacci√≥n:

* calcula resultado
* actualiza tabla de posiciones
* dispara suspensiones

---

## 8.4.2 Disciplina

### Registrar sanci√≥n disciplinaria

```
POST /api/disciplinas/sanciones
```

Descripci√≥n:
Registra una suspensi√≥n manual (tribunal / administrativa).

Roles:

* SUPERUSUARIO
* ADMIN

---

### Cierre autom√°tico de suspensi√≥n

```
POST /api/disciplinas/suspensiones/{id_suspension}/cerrar
```

Descripci√≥n:
Cierra una suspensi√≥n cuando se cumple la condici√≥n (fechas cumplidas).

Notas:

* Puede ejecutarse por job o acci√≥n manual

---

## 8.4.3 Habilitaciones

### Listar jugadores habilitados para un partido

```
GET /api/partidos/{id_partido}/habilitados
```

Descripci√≥n:
Devuelve jugadores sin sanci√≥n activa y correctamente inscriptos.

Roles:

* ADMIN
* EDITOR

---

# Paso 8.5 ‚Äì Consultas avanzadas y reportes

Estos endpoints son de solo lectura, pero con l√≥gica de negocio agregada.

## 8.5.1 Disciplina

### Historial disciplinario completo

```
GET /api/reportes/personas/{id_persona}/disciplina
```

Incluye:

* tarjetas
* suspensiones
* torneos

---

## 8.5.2 Torneos

### Tabla de posiciones hist√≥rica

```
GET /api/reportes/torneos/{id_torneo}/posiciones
```

Descripci√≥n:
Tabla final o parcial seg√∫n estado del torneo.

---

### Resultados por equipo

```
GET /api/reportes/equipos/{id_equipo}/resultados
```

---

## 8.5.3 Operativos

### Partidos pendientes de cierre

```
GET /api/reportes/partidos/pendientes-cierre
```

Roles:

* ADMIN
* SUPERUSUARIO

---

## Cierre del bloque de endpoints

Con los pasos 8.1 a 8.5 definidos, el sistema cuenta con:

* API p√∫blica
* API privada
* API administrativa
* Acciones de negocio
* Reportes

Este documento queda listo para:

* implementaci√≥n backend
* documentaci√≥n t√©cnica
* definici√≥n de DTOs
* versionado de API

# Paso 9 ‚Äì Contratos de datos (DTOs)

Este paso define los **contratos expl√≠citos** entre la API y sus consumidores. Los DTOs desacoplan la base de datos del modelo expuesto y fijan expectativas estables.

Los DTOs se organizan por **dominio**, no por endpoint.

---

## 9.1 Principios generales

* Los DTOs **no reflejan tablas** directamente
* No se exponen IDs internos innecesarios
* Fechas en formato ISO-8601
* Enums expl√≠citos
* Campos opcionales bien definidos

---

## 9.2 DTOs p√∫blicos (API p√∫blica)

### TorneoPublicDTO

Campos:

* id: number
* nombre: string
* categoria: string
* genero: string
* fecha_inicio: string
* fecha_fin: string | null

---

### EquipoPublicDTO

Campos:

* id: number
* nombre: string
* club: string

---

### PartidoPublicDTO

Campos:

* id: number
* equipo_local: string
* equipo_visitante: string
* goles_local: number
* goles_visitante: number
* fecha: string
* estado: "PROGRAMADO" | "JUGADO"

---

### PosicionDTO

Campos:

* equipo: string
* puntos: number
* partidos_jugados: number
* diferencia_gol: number

---

## 9.3 DTOs privados

### PersonaDTO

Campos:

* id: number
* nombre: string
* apellido: string
* documento: string
* fecha_nacimiento: string
* genero: string

Notas:

* Visible solo para roles habilitados

---

### PlantelDTO

Campos:

* id: number
* equipo: string
* temporada: string
* integrantes: PersonaDTO[]

---

### PartidoInternoDTO

Campos:

* id: number
* equipo_local_id: number
* equipo_visitante_id: number
* fecha: string
* jugado: boolean
* cerrado: boolean

---

## 9.4 DTOs administrativos

### CrearClubRequestDTO

Campos:

* nombre: string
* abreviatura: string

---

### CrearEquipoRequestDTO

Campos:

* nombre: string
* id_club: number
* categoria: string
* genero: string

---

### CrearPersonaRequestDTO

Campos:

* nombre: string
* apellido: string
* documento: string
* fecha_nacimiento: string
* genero: string

---

## 9.5 DTOs de acciones de negocio

### EventoPartidoRequestDTO

Campos:

* tipo: "GOL" | "AMARILLA" | "ROJA" | "OBSERVACION"
* minuto: number
* id_persona: number | null
* observacion: string | null

---

### SancionRequestDTO

Campos:

* id_persona: number
* motivo: string
* fechas_suspension: number

---

## Cierre del paso 9

Con estos DTOs definidos:

* la API tiene contratos estables
* el frontend puede trabajar en paralelo
* el backend queda desacoplado de la DB

El siguiente paso l√≥gico es definir **validaciones y errores por DTO**.

# Paso 10 ‚Äì Validaciones y modelo de errores

Este paso define **c√≥mo valida el sistema** y **c√≥mo responde ante errores**, garantizando consistencia y previsibilidad para todos los consumidores de la API.

---

## 10.1 Principios generales

* Todas las validaciones ocurren **antes** de ejecutar l√≥gica de negocio
* Los errores son **determin√≠sticos** y documentados
* Un mismo error siempre devuelve el mismo c√≥digo HTTP
* Los mensajes est√°n pensados para ser consumidos por frontend

---

## 10.2 Modelo est√°ndar de error

### ErrorResponseDTO

Campos:

* codigo: string
* mensaje: string
* detalle: string | null
* timestamp: string

Ejemplo:

```
{
  "codigo": "PARTIDO_CERRADO",
  "mensaje": "El partido ya fue cerrado",
  "detalle": null
}
```

---

## 10.3 Errores comunes

| C√≥digo                | HTTP | Descripci√≥n              |
| --------------------- | ---- | ------------------------ |
| RECURSO_NO_ENCONTRADO | 404  | Entidad inexistente      |
| ACCESO_DENEGADO       | 403  | Rol sin permiso          |
| DATOS_INVALIDOS       | 400  | Validaci√≥n de campos     |
| CONFLICTO_ESTADO      | 409  | Estado incompatible      |
| REGLA_NEGOCIO         | 422  | Regla de dominio violada |

---

## 10.4 Validaciones por dominio

### Club / Equipo

* Nombre obligatorio y √∫nico
* No se permite borrar si tiene relaciones activas

Errores:

* CLUB_CON_EQUIPOS_ASOCIADOS (409)

---

### Personas

* Documento √∫nico
* Fecha de nacimiento v√°lida

Errores:

* DOCUMENTO_DUPLICADO (409)

---

### Planteles

* Una persona no puede estar dos veces en el mismo plantel
* No se permite modificar plantel con torneo iniciado

Errores:

* PERSONA_YA_EN_PLANTEL (409)
* TORNEO_EN_CURSO (409)

---

### Partidos

* No se pueden cargar eventos en partidos cerrados
* Los equipos deben estar inscriptos

Errores:

* PARTIDO_CERRADO (409)
* EQUIPO_NO_INSCRIPTO (422)

---

### Disciplina

* No se puede sancionar a una persona sin participaci√≥n
* No se puede habilitar jugador con suspensi√≥n activa

Errores:

* SUSPENSION_ACTIVA (422)
* PERSONA_NO_HABILITADA (422)

---

## 10.5 Validaciones en acciones cr√≠ticas

### Cerrar partido

Validaciones:

* Partido existe
* Partido no cerrado previamente
* Resultado consistente

Errores:

* PARTIDO_INEXISTENTE (404)
* PARTIDO_YA_CERRADO (409)

---

### Inscribir equipo en torneo

Validaciones:

* Torneo activo
* Equipo no inscripto previamente

Errores:

* TORNEO_INACTIVO (409)
* EQUIPO_YA_INSCRIPTO (409)

---

## Cierre del paso 10

Con este modelo:

* la API es consistente
* los errores son predecibles
* el frontend puede reaccionar correctamente

El siguiente paso es definir la **arquitectura de implementaci√≥n backend**.

# Paso 11 ‚Äì Arquitectura de implementaci√≥n backend

Este paso define **c√≥mo se implementa el sistema en c√≥digo**, alineado con la estructura real del proyecto. El objetivo es mantener una arquitectura clara, predecible y escalable.

---

## 11.1 Regla de oro de responsabilidades

* routers ‚Üí HTTP, dependencias, permisos
* services ‚Üí reglas de negocio y orquestaci√≥n
* models ‚Üí persistencia (ORM)
* schemas ‚Üí contratos API (DTOs)
* dependencies ‚Üí auth y permisos
* utils ‚Üí helpers puros y transacciones
* db ‚Üí acceso y helpers de base de datos

Ninguna capa debe asumir responsabilidades de otra.

---

## 11.2 Flujo est√°ndar de una request

1. Router recibe la request
2. Se validan autenticaci√≥n y permisos
3. Se parsea el schema de entrada
4. El service ejecuta la l√≥gica de negocio
5. Se interact√∫a con los models
6. Se confirman o revierten transacciones
7. Se devuelve el schema de respuesta

---

## 11.3 Routers

Ubicaci√≥n:

* app/routers/

Responsabilidades:

* Definir endpoints
* Inyectar dependencias
* Aplicar control de roles

No contienen l√≥gica de negocio.

---

## 11.4 Services

Ubicaci√≥n:

* app/services/

Responsabilidades:

* Validar reglas de dominio (Paso 10)
* Coordinar m√∫ltiples modelos
* Controlar estados y transiciones
* Disparar efectos colaterales

Ejemplos:

* cerrar partido
* registrar eventos
* calcular posiciones
* aplicar sanciones

---

## 11.5 Models

Ubicaci√≥n:

* app/models/

Caracter√≠sticas:

* Representan tablas
* Definen relaciones
* No contienen l√≥gica de negocio compleja

---

## 11.6 Schemas

Ubicaci√≥n:

* app/schemas/

Caracter√≠sticas:

* Implementan DTOs del Paso 9
* Separan request y response
* Son la base de la documentaci√≥n OpenAPI

---

## 11.7 Dependencies

Ubicaci√≥n:

* app/dependencies/

Responsabilidades:

* Autenticaci√≥n
* Autorizaci√≥n por roles

Los services asumen que los permisos ya fueron validados.

---

## 11.8 Utils

Ubicaci√≥n:

* app/utils/

Incluye:

* helpers transaccionales
* validaciones puras
* funciones reutilizables

---

## 11.9 Jobs y tareas autom√°ticas

La arquitectura permite incorporar tareas como:

* cierre autom√°tico de suspensiones
* control de partidos abiertos
* rec√°lculo de posiciones

Sin modificar la API existente.

---

## Cierre del paso 11

Con este paso, el documento cubre:

* dise√±o funcional
* contratos API
* reglas de negocio
* modelo de errores
* arquitectura de implementaci√≥n

El proyecto queda **listo para comenzar el desarrollo de c√≥digo** de forma ordenada y sin decisiones improvisadas.
